<!doctype html>
<html lang = "ko">
    <head>
        <meta charset = "utf-8">
        <title>Calculator</title>
        <link href = "sub/style.css" rel = "stylesheet" type = "text/css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <script src='sub/math.js' type='text/javascript'></script>
    

        <script type = "text/javascript">
            function numberWithCommas(x) {
                return Number(x).toLocaleString('en');
            }

            $(document).ready(function() {
                var parser = math.parser();
                var displayValue = '0';
                $('#formula').text(displayValue);

                $('td').each(function(index, key) {
                    $(this).click(function(e) {
                        if(displayValue == '0') 
                            displayValue = '';

                $("#History").dblclick(function(event) {
                    $('#formula').text($('#History').text());
                    displayValue = $('#formula').text();
                });

                        if($(this).text() == 'EV') {
                            try {
                                if(displayValue == '')
                                    return;

                                displayValue = parser.eval(displayValue).toString();
                                var tokens = displayValue.split(' ');
                                if(tokens[0] == 'function') {
                                    displayValue = tokens[0];
                                }
                                    
                                if(displayValue == 'false' || displayValue == 'true' || displayValue.startsWith("[")) {
                                    $('#result').text(displayValue);
                                    $('#History').text($('#formula').text());
                                } else if(displayValue == 'function' || $('#formula').text().startsWith("x=") || $('#formula').text().startsWith("y=") || $('#formula').text().startsWith("z=")) {
                                    $('#result').text(displayValue);
                                    $('#History').text($('#formula').text());
                                    $("#Variable").prepend($('#formula').text() + "<br>");
                                    
                                    var str = $('#Variable').html().split("<br>");
                                    $('#Variable').empty();

                                    for(var i = 0; i < str.length-1; i++) {
                                        
                                        if(str[i] == $("#formula").text()) {
                                            str[i] = $("#formula").text() + "<br>";
                                        }
                                        else if(displayValue == 'function') {
                                            if(str[i].substring(0,4) == $("#formula").text().substring(0,4)) {
                                                str[i] = null;
                                            } else {
                                                str[i] += "<br>";
                                            }
                                        }
                                        else {
                                            if(str[i].substring(0,2) == $("#formula").text().substring(0,2)) {
                                                str[i] = null;
                                            } else {
                                                str[i] += "<br>";
                                            }
                                        }

                                        $('#Variable').append(str[i]);
                                    }
                                }
                                else {
                                    $('#result').text(numberWithCommas(displayValue));
                                    $('#History').text($('#formula').text());
                                }
                                displayValue = '0';
                                
                            }
                            catch(e) {
                                displayValue = '0';
                                if(displayValue != 'function') {
                                    $('#formula').text(e); // e
                                }
                            }
                        }
                        else {
                            if($(this).text() == 'Clear') {
                                displayValue = '0';
                                $('#formula').text(displayValue);
                                $('#result').text('');
                            } else if($(this).text() == '←') {
                                if($('#formula').text() != '0') {
                                    displayValue = $('#formula').text().substring(0, $('#formula').text().length-1);
                                    $('#formula').text(displayValue);
                                }
                            } else if($(this).text() == 'x²') {
                                displayValue = $('#formula').text() + "^2";
                                $('#formula').text(displayValue);
                            } else if($(this).text() == 'x^y') {
                                displayValue = $('#formula').text() + "^";
                                $('#formula').text(displayValue);
                            } else if($(this).text() == '√x') {
                                if($('#formula').text() != '0') {
                                    displayValue = "sqrt(" + $('#formula').text() + ")";
                                    $('#formula').text(displayValue);
                                }
                            } else if($(this).text() == 'x!') {
                                displayValue = "factorial(" + $('#formula').text() + ")";
                                $('#formula').text(displayValue);
                            }
                            else {
                                displayValue += $(this).text();
                                $('#formula').text(displayValue);
                            }
                        }
                    })
                })
            })
        </script>

    </head>
    <body>
        <div id = "bg">
            <div class = "display">
                <div id = "formula"></div>
                <div id = "result"></div>
            </div>

            <div class = "bt">
                <table class = "keyTable">
                    <tr>
                        <td><span class = "key funkey" data-tooltip-text="ln(x)">log</span></td>
                        <td><span class = "key funkey" data-tooltip-text="exp(x) = e^x">exp</span></td>
                        <td><span class = "key funkey" data-tooltip-text="factorial(x)">x!</span></td>
                        <td><span class = "key funkey">==</span></td>
                        <td><span class = "key funkey">></span></td>
                        <td><span class = "key funkey"><</span></td>
                        <td><span class = "key">[</span></td>
                        <td><span class = "key">]</span></td>
                        <td><span class = "key" data-tooltip-text="sin(90deg) = 1">deg</span></td>
                    </tr>
                    <tr>
                        <td><span class = "key funkey" data-tooltip-text="ex) sin(x)">sin</span></td>
                        <td><span class = "key funkey" data-tooltip-text="ex) cos(x)">cos</span></td>
                        <td><span class = "key funkey" data-tooltip-text="ex) tan(x)">tan</span></td>
                        <td><span class = "key funkey">!=</span></td>
                        <td><span class = "key funkey">>=</span></td>
                        <td><span class = "key funkey"><=</span></td>
                        <td><span class = "key">(</span></td>
                        <td><span class = "key">)</span></td>
                        <td><span class = "key clearKey">Clear</span></td>
                    </tr>
                    <tr>
                        <td><span class = "key funkey" data-tooltip-text="dot([2, 4, 1], [2, 2, 3]) dot product">dot</span></td>
                        <td><span class = "key funkey" data-tooltip-text="cross([1, 1, 0], [0, 1, 1]) cross product">cross</span></td>
                        <td><span class = "key funkey" data-tooltip-text="sqrt(x)">√x</span></td>
                        <td><span class = "key funkey" data-tooltip-text="Mod Operator">%</span></td>
                        <td><span class = "key">7</span></td>
                        <td><span class = "key">8</span></td>
                        <td><span class = "key">9</span></td>
                        <td><span class = "key">/</span></td>
                        <td><span class = "key clearKey">←</span></td>
                    </tr>
                    <tr>
                        <td><span class = "key funkey" data-tooltip-text= "det([[1, 2], [3, 4]]) determinant">det</span></td>
                        <td><span class = "key funkey" data-tooltip-text= "inv([[1, 2], [3, 4]]) inverse">inv</span></td>
                        <td><span class = "key funkey">x^y</span></td>
                        <td><span class = "key funkey">x²</span></td>
                        <td><span class = "key">4</span></td>
                        <td><span class = "key">5</span></td>
                        <td><span class = "key">6</span></td>
                        <td><span class = "key">*</span></td>
                        <td><span class = "key equal" style = "height:25px;" data-tooltip-text="Function Equal">=</span></td>
                    </tr>
                    <tr>
                        <td><span class = "key symbolKey" data-tooltip-text= "ex) f(x)=x^2+2x">f</span></td>
                        <td><span class = "key symbolKey" data-tooltip-text= "ex) g(x)=x^2+2x">g</span></td>
                        <td><span class = "key funkey">e</span></td>
                        <td><span class = "key funkey">pi</span></td>
                        <td><span class = "key">1</span></td>
                        <td><span class = "key">2</span></td>
                        <td><span class = "key">3</span></td>
                        <td><span class = "key">+</span></td>
                        <td rowspan= "2"><span class = "key equal">EV</span></td>
                    </tr>
                    <tr>
                        <td><span class = "key symbolKey" data-tooltip-text="ex) x = 3">x</span></td>
                        <td><span class = "key symbolKey" data-tooltip-text="ex) y = 3">y</span></td>
                        <td><span class = "key symbolKey" data-tooltip-text="ex) z = 3">z</span></td>
                        <td><span class = "key symbolKey" data-tooltip-text="complex number">i</span></td>
                        <td><span class = "key">,</span></td>
                        <td><span class = "key">0</span></td>
                        <td><span class = "key">.</span></td>
                        <td><span class = "key">-</span></td>
                    </tr>
                </table>

            </div>
            <div class = "TopButton">
                <span class = "key tBut active">History</span>
                <span class = "key tBut">Variable</span>
            </div>
            <div class = "func show" id = "History">
            </div>
            <div class = "func" id = "Variable">
            </div>
        </div>

        <script>

            $(function() {
                $("span.key.tBut").click(function() {
                    $("span.key.tBut.active").removeClass("active");
                    $(this).addClass("active");
                    
                    if($(this).text() == "History" && !$("#History").hasClass("show")) {
                        $("#Variable").removeClass("show");
                        $("#History").addClass("show");
                    }
                    else if($(this).text() == "Variable" && !$("#Variable").hasClass("show")) {
                        $("#History").removeClass("show");
                        $("#Variable").addClass("show");
                    }
                });
                
            });

        </script>

    </body>
</html>